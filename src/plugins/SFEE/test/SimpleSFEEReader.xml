<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">
 
  <description><![CDATA[
  First configuration that adresses the SFEE to QC conection
  ]]></description>
  
  <bean class="org.openadaptor.core.jmx.MBeanServer">
    <description>Embed this in your config to expose jmx interface via http and rmi.</description>
    <constructor-arg value="8082"/>
  </bean>
  
  <bean id="SystemUtil" class="org.openadaptor.util.SystemUtil">
    <description>Embed this in your config to expose useful management bean.</description>
  </bean>
  
  <bean id="LogAdmin" class="org.openadaptor.thirdparty.log4j.LogAdmin">
    <description>Embed this in your config to expose log4j management.</description>
  </bean>
  
  <bean id="Adaptor" class="org.openadaptor.core.adaptor.Adaptor">
    <property name="messageProcessor" ref="Router"/>
  </bean>
  
  <bean id="Router" class="org.openadaptor.core.router.Router">
    
    <property name="processMap">
      <map>
			<entry key-ref="SFEEPollingReader" value-ref="SFEEReadConnector"/>
  			<entry key-ref="QCPollingReader" value-ref="QCReadConnector"/>
        	<entry key-ref="SFEEReadConnector"> 
        		<list>
        			<ref bean="SFEEEasyXMLAccessor"/>
            		<ref bean="SFEEXsltProcessor"/>
          		</list>
        	</entry>
        	
        	<entry key-ref="QCReadConnector"> 
        		<list>
        			<ref bean="QCEasyXMLAccessor"/>
            		<ref bean="QCXsltProcessor"/>
          		</list>
        	</entry>
        	
           <entry key-ref="QCXsltProcessor" value-ref="SFEEEntityService"/>
        	
	       <entry key-ref="SFEEEntityService" value-ref="SFEEWriteConnector"/>
        	
	       <entry key-ref="SFEEEasyXMLAccessor">
	       <list>
        			<ref bean="Writer"/>
            		<ref bean="SFEESQLConverter"/>
          	</list>
        	</entry>
	       <entry key-ref="QCEasyXMLAccessor">
	       <list>
        			<ref bean="Writer"/>
            		<ref bean="QCSQLConverter"/>
          	</list>
        	</entry>
	       
	       <entry key-ref="QCSQLConverter" value-ref="QCDatabaseWriter"/>
           <entry key-ref="SFEESQLConverter" value-ref="SFEEDatabaseWriter"/>
           <entry key-ref="SFEEXsltProcessor" value-ref="QCEntityService"/>
           <entry key-ref="QCEntityService" value-ref="QCWriteConnector"/>
      </map>  
    </property>
    <property name="exceptionProcessor" ref="ExceptionHandler"/>
    <property name="discardMap">
      <map>
      <!--    <entry key-ref="Filter" value-ref="DiscardLog"/> -->
      </map>
    </property>
  </bean>
  
   
   <bean id="SFEEPollingReader" class="de.galileo.panama.PanamaLoopingPollingReadConnector">
     <description>
       Poller which wraps SFEE Reader and every 5 seconds.
     </description>              
     <property name="pollLimit" value="-1"/>
     <property name="delegate" ref="SFEEDatabaseReader"/>
     <property name="pollIntervalSecs"     value="5"/>
  </bean>
  
  <bean id="QCPollingReader" class="de.galileo.panama.PanamaLoopingPollingReadConnector">
     <description>
       Poller which wraps QC Reader and every 5 seconds.
       (More example config parameters commented out.)
     </description>              
     <property name="pollLimit" value="-1"/>
     <property name="delegate" ref="QCDatabaseReader"/>
     <!--<property name="pollIntervalHours"  value="1"/>-->
     <!--<property name="pollIntervalMins"   value="1"/>-->
     <property name="pollIntervalSecs"     value="5"/>
     <!--<property name="pollIntervalMs"   value="5000"/>-->
  </bean>
   
   <bean id="SFEEReadConnector" class="de.galileo.panama.SFEEReadConnector">
    <property name="username" value="admin"/>
    <property name="password" value="admin"/>
    <property name="serverUrl" value="http://sfee-sap.cubit.sp.collab.net"/>
    <property name="keepAlive" value="true"/>
   </bean>
   
   <bean id="QCReadConnector" class="com.collabnet.connector.qc.QCReadConnector">
    <property name="userName" value="admin"/>
    <property name="password" value="collabnet"/>
    <property name="serverUrl" value="http://10.2.1.114:8080/qcbin"/>
    <property name="projectName" value="PRJ_1"/>
    <property name="domain" value="DOMAIN_PRJ_1"/>
    <property name="keepAlive" value="true"/>
   </bean>
   
   <bean id="SFEEEntityService" class="de.galileo.panama.SFEEEntityService">
    <property name="username" value="admin"/>
    <property name="password" value="admin"/>
    <property name="serverUrl" value="http://sfee-sap.cubit.sp.collab.net"/>
    <property name="keepAlive" value="true"/>
    <property name="synchronizationUser" value="admin"/>
    <property name="otherSystemInSFEETargetFieldname" value="QC-Id"/>
    <property name="createToken" value="CREATE"/>
   </bean>
   
   <bean id="QCEntityService" class="com.collabnet.connector.qc.QCEntityService">
 	<property name="userName" value="admin"/>
    <property name="password" value="collabnet"/>
    <property name="serverUrl" value="http://10.2.1.114:8080/qcbin"/>
    <property name="projectName" value="PRJ_1"/>
    <property name="domain" value="DOMAIN_PRJ_1"/>
    <property name="keepAlive" value="true"/>	    
    <property name="otherSystemInQCTargetFieldname" value="BG_USER_09"/>
    <property name="createToken" value="CREATE"/>
    <property name="synchronizationUser" value="admin"/>
   </bean>
   
   
   <bean id="SFEEWriteConnector" class="de.galileo.panama.SFEEWriteConnector">
    <property name="username" value="admin"/>
    <property name="password" value="admin"/>
    <property name="serverUrl" value="http://sfee-sap.cubit.sp.collab.net"/>
    <property name="keepAlive" value="true"/>
    <property name="createToken" value="CREATE"/>
    <property name="updateComment" value="Synchronized by QC2SFEE"/>
    <property name="otherSystemVersionInSFEETargetFieldname" value="QC-Version"/>
    <property name="lastSynchronizedWithOtherSystemSFEETargetFieldname" value="lastSynchronizedVersion"/>
   </bean>
   
   <bean id="QCWriteConnector" class="com.collabnet.connector.qc.QCWriteConnector">
 	<property name="userName" value="admin"/>
    <property name="password" value="collabnet"/>
    <property name="serverUrl" value="http://10.2.1.114:8080/qcbin"/>
    <property name="projectName" value="PRJ_1"/>
    <property name="domain" value="DOMAIN_PRJ_1"/>
    <property name="keepAlive" value="true"/>
    <property name="createToken" value="CREATE"/>
   </bean>
  
  <bean id="Writer" class="org.openadaptor.auxil.connector.iostream.writer.FileWriteConnector"/>
  <bean id="ExceptionHandler" class="org.openadaptor.auxil.connector.iostream.writer.FileWriteConnector"/>
  
  
  <bean id="SFEEJdbcConnectionRead" class="org.openadaptor.auxil.connector.jdbc.JDBCConnection">
    <description>This defines jdbc connection.</description>
    <property name="driver" value="org.hsqldb.jdbcDriver"/>
    <property name="url" value="jdbc:hsqldb:hsql://localhost/xdb"/>
    <property name="username" value="sa"/>
    <property name="password" value=""/>
  </bean>
  
  <bean id="QCJdbcConnectionRead" class="org.openadaptor.auxil.connector.jdbc.JDBCConnection">
    <description>This defines jdbc connection.</description>
    <property name="driver" value="org.hsqldb.jdbcDriver"/>
    <property name="url" value="jdbc:hsqldb:hsql://localhost/xdb"/>
    <property name="username" value="sa"/>
    <property name="password" value=""/>
  </bean>
  
  <bean id="SFEEJdbcConnectionWrite" class="org.openadaptor.auxil.connector.jdbc.JDBCConnection">
    <description>This defines jdbc connection.</description>
    <property name="driver" value="org.hsqldb.jdbcDriver"/>
    <property name="url" value="jdbc:hsqldb:hsql://localhost/xdb"/>
    <property name="username" value="sa"/>
    <property name="password" value=""/>
  </bean>
  
  <bean id="QCJdbcConnectionWrite" class="org.openadaptor.auxil.connector.jdbc.JDBCConnection">
    <description>This defines jdbc connection.</description>
    <property name="driver" value="org.hsqldb.jdbcDriver"/>
    <property name="url" value="jdbc:hsqldb:hsql://localhost/xdb"/>
    <property name="username" value="sa"/>
    <property name="password" value=""/>
  </bean>

  <bean id="SFEEDatabaseReader" class="org.openadaptor.auxil.connector.jdbc.reader.JDBCReadConnector">
    <description>Reader which polls database using configured SQL.</description>
    <property name="jdbcConnection" ref="SFEEJdbcConnectionRead"/>
    <!-- batch size of 0 or less means process all rows in one message batch. -->
    <!-- batch size of one means process one row per message and so on -->
    <property name="batchSize" value="0"/>
    <property name="resultSetConverter" ref="SFEEResultSetConverter"/>
    <property name="sql">
      <value>
        SELECT * 
        FROM SFEE_SYNC_INFO
      </value>
    </property>
  </bean>
  
  <bean id="QCDatabaseReader" class="org.openadaptor.auxil.connector.jdbc.reader.JDBCReadConnector">
    <description>Reader which polls database using configured SQL.</description>
    <property name="jdbcConnection" ref="QCJdbcConnectionRead"/>
    <!-- batch size of 0 or less means process all rows in one message batch. -->
    <!-- batch size of one means process one row per message and so on -->
    <property name="batchSize" value="0"/>
    <property name="resultSetConverter" ref="QCResultSetConverter"/>
    <property name="sql">
      <value>
        SELECT * 
        FROM QC_SYNC_INFO
      </value>
    </property>
  </bean>
  
  <bean id="SFEEResultSetConverter" class="org.openadaptor.auxil.connector.jdbc.reader.xml.ResultSetToXMLConverter">
	<property name="convertToString" value="false"/>
	<property name="rootElement" value="SFEETimestamp"/>  
  </bean>
  
  <bean id="QCResultSetConverter" class="org.openadaptor.auxil.connector.jdbc.reader.xml.ResultSetToXMLConverter">
	<property name="convertToString" value="false"/>
	<property name="rootElement" value="QCSyncInf"/>  
  </bean>
  
  <bean id="SFEESQLConverter" class="org.openadaptor.thirdparty.velocity.VelocityProcessor">
    <property name="templateString">
      <value>
        UPDATE SFEE_SYNC_INFO SET ARTIFACTVERSION = '$data.get("//field[@name='version' and @isFlexField='false']/value'")', ARTIFACTID = '$data.get("//field[@name='Id' and @isFlexField='false']/value'")' , TIMESTAMP = '$data.get("//field[@name='lastModifiedDate' and @isFlexField='false']/value'")' WHERE TRACKERID = '$data.get("//field[@name='folderId' and @isFlexField='false']/value'")'
      </value>
    </property>
  </bean>
  
  <bean id="QCSQLConverter" class="org.openadaptor.thirdparty.velocity.VelocityProcessor">
    <property name="templateString">
      <value>
        UPDATE QC_SYNC_INFO SET FROMTIME = '$data.get("//field[@name='fromTime' and @isFlexField='false']/value'")', TOTIME = '$data.get("//field[@name='toTime' and @isFlexField='false']/value'")' WHERE PROJECT = '$data.get("//field[@name='project' and @isFlexField='false']/value'")'
      </value>
    </property>
  </bean>
  
  <bean id="SFEEDatabaseWriter" class="org.openadaptor.auxil.connector.jdbc.writer.JDBCWriteConnector">
    <property name="jdbcConnection" ref="SFEEJdbcConnectionWrite"/>
  </bean>
  
  <bean id="QCDatabaseWriter" class="org.openadaptor.auxil.connector.jdbc.writer.JDBCWriteConnector">
    <property name="jdbcConnection" ref="QCJdbcConnectionWrite"/>
  </bean>
  
  <bean id="SFEEEasyXMLAccessor" class="org.openadaptor.auxil.convertor.simplerecord.ToSimpleRecordConvertor">
    <property name="simpleRecordAccessor">
      <bean class="org.openadaptor.thirdparty.dom4j.Dom4jSimpleRecordAccessor"/>
    </property>
  </bean>
  
  <bean id="QCEasyXMLAccessor" class="org.openadaptor.auxil.convertor.simplerecord.ToSimpleRecordConvertor">
    <property name="simpleRecordAccessor">
      <bean class="org.openadaptor.thirdparty.dom4j.Dom4jSimpleRecordAccessor"/>
    </property>
  </bean>
  
  <bean id="SFEEXsltProcessor" class="de.galileo.panama.XsltProcessor">
   <property name="xsltFile" value="sfee2qc.xsl"/>
  </bean>
  
  <bean id="QCXsltProcessor" class="de.galileo.panama.XsltProcessor">
   <property name="xsltFile" value="qc2sfee.xsl"/>
  </bean>
  
</beans>
